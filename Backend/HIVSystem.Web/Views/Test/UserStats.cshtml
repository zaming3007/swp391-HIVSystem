@{
    ViewData["Title"] = "Thống kê người dùng";
    var stats = ViewBag.Stats as List<dynamic>;
    var totalUsers = (int)ViewBag.TotalUsers;
    var activeUsers = (int)ViewBag.ActiveUsers;
    var recentUsers = (int)ViewBag.RecentUsers;

    var roleNames = new Dictionary<int, string>
    {
        { 1, "Quản trị viên" },
        { 2, "Bác sĩ" },
        { 3, "Bệnh nhân" },
        { 4, "Y tá" },
        { 5, "Dược sĩ" }
    };
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-bar text-primary"></i> Thống kê Người dùng</h2>
                <div>
                    <a asp-action="Database" class="btn btn-outline-primary">
                        <i class="fas fa-database"></i> Database Test
                    </a>
                    <a asp-controller="Account" asp-action="Register" class="btn btn-success">
                        <i class="fas fa-user-plus"></i> Đăng ký User mới
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@totalUsers</h4>
                            <span>Tổng số Users</span>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@activeUsers</h4>
                            <span>Users Hoạt động</span>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@(totalUsers - activeUsers)</h4>
                            <span>Users Ngưng hoạt động</span>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-times fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@recentUsers</h4>
                            <span>Users mới (7 ngày)</span>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-plus fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Tables -->
    <div class="row">
        <!-- Role Distribution Chart -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-pie-chart"></i> Phân bố theo Vai trò</h5>
                </div>
                <div class="card-body">
                    <canvas id="roleChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Stats Table -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-table"></i> Chi tiết theo Vai trò</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Vai trò</th>
                                    <th>Tổng</th>
                                    <th>Hoạt động</th>
                                    <th>Ngưng hoạt động</th>
                                    <th>%</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (stats != null)
                                {
                                    @foreach (var stat in stats)
                                    {
                                        var roleName = roleNames.ContainsKey(stat.RoleID) ? roleNames[stat.RoleID] : $"Role {stat.RoleID}";
                                        var percentage = totalUsers > 0 ? (stat.Count * 100.0 / totalUsers) : 0;
                                        
                                        <tr>
                                            <td>
                                                <span class="badge badge-role-@stat.RoleID">@roleName</span>
                                            </td>
                                            <td><strong>@stat.Count</strong></td>
                                            <td><span class="text-success">@stat.ActiveCount</span></td>
                                            <td><span class="text-warning">@stat.InactiveCount</span></td>
                                            <td>@percentage.ToString("F1")%</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Chưa có dữ liệu</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-tools"></i> Thao tác nhanh</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <a asp-controller="Account" asp-action="Register" class="btn btn-outline-success btn-block mb-2">
                                <i class="fas fa-user-plus"></i> Đăng ký User mới
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a asp-action="CreatePlainTextUsers" class="btn btn-outline-primary btn-block mb-2">
                                <i class="fas fa-users-cog"></i> Tạo Users Test
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a asp-action="ConvertToPlainText" class="btn btn-outline-warning btn-block mb-2">
                                <i class="fas fa-key"></i> Convert Plain Text
                            </a>
                        </div>
                        <div class="col-md-3">
                            <button onclick="location.reload()" class="btn btn-outline-info btn-block mb-2">
                                <i class="fas fa-sync-alt"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .badge-role-1 { background-color: #dc3545; }
    .badge-role-2 { background-color: #007bff; }
    .badge-role-3 { background-color: #28a745; }
    .badge-role-4 { background-color: #ffc107; color: #000; }
    .badge-role-5 { background-color: #6f42c1; }
    
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
        border-radius: 0.375rem;
    }
    
    .btn-block {
        display: block;
        width: 100%;
    }
    
    canvas {
        max-height: 300px;
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Role Distribution Pie Chart
        const ctx = document.getElementById('roleChart').getContext('2d');
        
        // Prepare role data safely
        var roleData = [];
        @if (stats != null && stats.Any())
        {
            <text>
            roleData = @Html.Raw(Json.Serialize(stats.Select(s => new { 
                label = roleNames.ContainsKey(s.RoleID) ? roleNames[s.RoleID] : $"Role {s.RoleID}",
                value = s.Count,
                roleId = s.RoleID
            })));
            </text>
        }

        const colors = ['#dc3545', '#007bff', '#28a745', '#ffc107', '#6f42c1'];
        
        if (roleData && roleData.length > 0) {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: roleData.map(item => item.label),
                    datasets: [{
                        data: roleData.map(item => item.value),
                        backgroundColor: roleData.map((item, index) => colors[index % colors.length]),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        } else {
            // Show message when no data
            const chartContainer = document.getElementById('roleChart').parentElement;
            chartContainer.innerHTML = '<div class="text-center text-muted p-4"><i class="fas fa-chart-pie fa-3x mb-3"></i><br>Chưa có dữ liệu để hiển thị</div>';
        }
    </script>
} 